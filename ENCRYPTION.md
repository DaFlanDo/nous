# Server-Side Encryption (E2EE)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Server-Side Encryption** –¥–ª—è –∑–∞—â–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö:

1. **–î–∞–Ω–Ω—ã–µ –≤ –ë–î –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã** - –≤—Å–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ (AES-256)
2. **–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –≤ –ø–∞–º—è—Ç–∏** - —Å–µ—Ä–≤–µ—Ä —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—É / –æ–±—Ä–∞–±–æ—Ç–∫–∞ AI)
3. **–û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏** - –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ AI —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ –ø–∞–º—è—Ç–∏
4. **–ò–∑–æ–ª—è—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** - –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ (user_id —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)

## –ß—Ç–æ —à–∏—Ñ—Ä—É–µ—Ç—Å—è

### Notes (–ó–∞–º–µ—Ç–∫–∏)
- `title` - –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏
- `content` - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–º–µ—Ç–∫–∏

### Checklist Templates (–®–∞–±–ª–æ–Ω—ã —á–µ–∫–ª–∏—Å—Ç–æ–≤)
- `name` - –Ω–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
- `items[]` - —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –≤ —à–∞–±–ª–æ–Ω–µ

### Daily Checklists (–î–Ω–µ–≤–Ω—ã–µ —á–µ–∫–ª–∏—Å—Ç—ã)
- `items[].text` - —Ç–µ–∫—Å—Ç –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏

### Chat Sessions (–°–µ—Å—Å–∏–∏ —á–∞—Ç–∞)
- `title` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `messages[].content` - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

### State Records (–ó–∞–ø–∏—Å–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- `analysis` - AI –∞–Ω–∞–ª–∏–∑ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ú–æ–¥—É–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (`encryption.py`)

```python
from encryption import get_encryption

# –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î
enc = get_encryption()
encrypted_data = enc.encrypt_dict(data, ['title', 'content'])
await db.notes.insert_one(encrypted_data)

# –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è –∏–∑ –ë–î
note = await db.notes.find_one({'id': note_id})
decrypted_note = enc.decrypt_dict(note, ['title', 'content'])
```

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

- `encrypt_note()` / `decrypt_note()` - –¥–ª—è –∑–∞–º–µ—Ç–æ–∫
- `encrypt_checklist_template()` / `decrypt_checklist_template()` - –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤
- `encrypt_checklist()` / `decrypt_checklist()` - –¥–ª—è —á–µ–∫–ª–∏—Å—Ç–æ–≤
- `encrypt_chat_session()` / `decrypt_chat_session()` - –¥–ª—è —á–∞—Ç–æ–≤
- `encrypt_state_record()` / `decrypt_state_record()` - –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# .env
ENCRYPTION_KEY=your-super-secret-encryption-key-min-32-chars
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞

```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

## –ê–ª–≥–æ—Ä–∏—Ç–º

- **–®–∏—Ñ—Ä**: AES-256 (Fernet symmetric encryption)
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞**: `cryptography` (Python)
- **–ö–ª—é—á**: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑ `ENCRYPTION_KEY` —á–µ—Ä–µ–∑ PBKDF2 (100,000 –∏—Ç–µ—Ä–∞—Ü–∏–π, SHA-256)
- **–§–æ—Ä–º–∞—Ç**: Base64 encoded ciphertext

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–∞–Ω–Ω—ã—Ö

### –ó–∞–ø–∏—Å—å (Write)
```
–ö–ª–∏–µ–Ω—Ç ‚Üí –°–µ—Ä–≤–µ—Ä (plaintext) ‚Üí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –ë–î (encrypted)
```

### –ß—Ç–µ–Ω–∏–µ (Read)
```
–ë–î (encrypted) ‚Üí –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ ‚Üí –°–µ—Ä–≤–µ—Ä (plaintext –≤ –ø–∞–º—è—Ç–∏) ‚Üí –ö–ª–∏–µ–Ω—Ç (plaintext)
                                          ‚Üì
                                   –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
```

### AI –û–±—Ä–∞–±–æ—Ç–∫–∞
```
–ë–î (encrypted) ‚Üí –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ ‚Üí OpenAI API (plaintext) ‚Üí –û—Ç–≤–µ—Ç
                                          ‚Üì
                                   –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ó–∞—â–∏—Ç–∞
- –î–∞–Ω–Ω—ã–µ –≤ –ë–î –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã - —É—Ç–µ—á–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
- –ö–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
- –ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - user_id —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ - –¥–∞–Ω–Ω—ã–µ –≤ plaintext —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

### ‚ö†Ô∏è –£–≥—Ä–æ–∑—ã
- –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è `ENCRYPTION_KEY` ‚Üí –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
- –£—è–∑–≤–∏–º–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ ‚Üí –¥–æ—Å—Ç—É–ø –∫ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º –≤ –ø–∞–º—è—Ç–∏
- Man-in-the-middle –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–æ–º –∏ OpenAI API

### üîí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–π `ENCRYPTION_KEY` (32+ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∏–º–≤–æ–ª–∞)
- –•—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á –≤ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º –º–µ—Å—Ç–µ (AWS Secrets Manager, HashiCorp Vault)
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –¥–ª—è –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º

## –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏. –§—É–Ω–∫—Ü–∏—è `decrypt()` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å - –µ—Å–ª–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –µ—Å—Ç—å.

–î–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç:

```python
# migration_encrypt.py
from encryption import init_encryption, get_encryption

init_encryption(ENCRYPTION_KEY)
enc = get_encryption()

# –®–∏—Ñ—Ä—É–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–º–µ—Ç–∫–∏
async for note in db.notes.find():
    encrypted = enc.encrypt_dict(note, ['title', 'content'])
    await db.notes.update_one({'_id': note['_id']}, {'$set': encrypted})
```

## –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ú–æ–¥—É–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è `encryption.py`
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ Notes
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ Templates
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ Checklists
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `.env`

üîÑ **–í –ø—Ä–æ—Ü–µ—Å—Å–µ:**
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ChatSessions
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ StateRecords
- –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ AI

‚è≥ **–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è:**
- –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
